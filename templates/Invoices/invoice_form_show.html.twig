<div class="modal-body">
    <div class="container-fluid">
        <div id="flash-message-overlay">
            <div class="col">
                {% include 'feedback.html.twig' with {'error': error, 'app': app } %}
            </div>
        </div>
        <div class="row">                
            <div class="col">
                <h4 class="invoice-edit-field d-none">{{ 'invoice.guest'|trans }}&nbsp;
                    <small>
                    <a href="#" onclick="return changeInvoiceCustomer({{ invoice.id }});"
                       title="{{ 'button.edit'|trans }}" class="text-secondary">
                        <i class="fas fa-edit"></i>
                    </a>
                    </small>
                </h4>
                {{ invoice.salutation }}
            </div>
            <div class="col text-right">
                <h4 class="invoice-edit-field d-none">
                    <small>
                        <a href="#" onclick="return changeInvoiceNumber({{ invoice.id }});"
                           title="{{ 'button.edit'|trans }}" class="text-secondary">
                            <i class="fas fa-edit"></i>
                        </a>
                    </small>
                </h4>
                <strong>{{ 'invoice.number'|trans }}</strong></div>
        </div>
        <div class="row">
            <div class="col">{{ invoice.firstname }} {{ invoice.lastname }}
                {% if invoice.company is not empty %}
                    <br/>{{ invoice.company }}
                {% endif %}
            </div>
            <div class="col text-right">{{ invoice.number }}</div>
        </div>
        <div class="row">
            <div class="col">{{ invoice.address }}</div>
            <div class="col text-right"><strong>{{ 'invoice.date'|trans }}</strong></div>
        </div>
        <div class="row">
            <div class="col">{{ invoice.zip }} {{ invoice.city }}</div>
            <div class="col text-right">{{ invoice.date|date('d.m.Y') }}</div>
        </div>

        <table class="table table-hover mt-4">
            <thead>
            <tr>
                <th>{{ 'invoice.position.appartment'|trans }}</th>
                <th class="text-right">{{ 'invoice.position.stays'|trans }}</th>
                <th class="text-right">{{ 'invoice.price.single'|trans }}</th>
                <th class="text-right">{{ 'invoice.vat'|trans }}</th>
                <th class="text-right">{{ 'invoice.price.total'|trans }}</th>
                <th class="invoice-edit-field d-none text-right">{{ 'invoice.action'|trans }}</th>
            </tr>
            </thead>
            <tbody>
            {% set appartmentSum = 0 %}
            {% for appartment in invoice.appartments %}
                {% set appartmentSum = appartmentSum + (appartment.price * appartment.amount) %}
                <tr>
                    <td>{{ appartment.description }} ({{ 'invoice.appartment.persons'|trans({'%count%': appartment.persons }) }})
                        <br/>{{ appartment.startDate|date('d.m.Y') }}
                        - {{ appartment.endDate|date('d.m.Y') }}</td>
                    <td class="text-right">{{ appartment.amount }}</td>
                    <td class="text-right">{{ appartment.price|number_format(2, ',', '.') }}</td>
                    <td class="text-right">
                        {% if is_decimal_place_0(appartment.vat) %}
                            {{ appartment.vat|number_format(0, ',', '.') }}
                        {% else %}
                            {{ appartment.vat|number_format(2, ',', '.') }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ (appartment.price * appartment.amount)|number_format(2, ',', '.') }}</td>
                    <td class="invoice-edit-field d-none text-right">
                        <a href="#" title="{{ 'button.edit'|trans }}">
                            <i onclick="return getContentForModal('{{ path('invoices.edit.apartment.position', {'invoiceId': invoice.id, 'id': appartment.id}) }}')" class="fas fa-edit"></i></a>
                        <a href="#" title="{{ 'button.delete'|trans }}">
                            <i onclick="return removeAppartmentPositionFromInvoicePositions({{ appartment.id }})"
                                class="fas fa-trash-alt"></i></a>
                    </td>
                </tr>
            {% endfor %}
            <tr>
                <th><button type="button" class="btn btn-secondary invoice-edit-field d-none" onclick="return getContentForModal('{{ path('invoices.new.apartment.position', {'invoiceId': invoice.id}) }}')">
                        <i class="fas fa-plus"></i> {{ 'invoice.position.add.appartment'|trans }}</button></th>
                <th colspan="5" class="text-right">{{ appartmentSum|number_format(2, ',', '.') }}</th>
            </tr>
            </tbody>
        </table>
        <table class="table table-hover mt-4">
            <thead>
            <tr>
                <th>{{ 'invoice.position.additional'|trans }}</th>
                <th class="text-right">{{ 'invoice.position.amount'|trans }}</th>
                <th class="text-right">{{ 'invoice.price.single'|trans }}</th>
                <th class="text-right">{{ 'invoice.vat'|trans }}</th>
                <th class="text-right">{{ 'invoice.price.total'|trans }}</th>
                <th class="invoice-edit-field d-none text-right">{{ 'invoice.action'|trans }}</th>
            </tr>
            </thead>
            <tbody>
            {% set positionSum = 0 %}
            {% for position in invoice.positions %}
                {% set positionSum = positionSum + (position.price * position.amount) %}
                <tr>
                    <td>{{ position.description }}</td>
                    <td class="text-right">{{ position.amount }}</td>
                    <td class="text-right">{{ position.price|number_format(2, ',', '.') }}</td>
                    <td class="text-right">
                        {% if is_decimal_place_0(position.vat) %}
                            {{ position.vat|number_format(0, ',', '.') }}
                        {% else %}
                            {{ position.vat|number_format(2, ',', '.') }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ (position.price * position.amount)|number_format(2, ',', '.') }}</td>
                    <td class="invoice-edit-field d-none text-right">
                        <a href="#" title="{{ 'button.edit'|trans }}">
                            <i onclick="return getContentForModal('{{ path('invoices.edit.miscellaneous.position', {'invoiceId': invoice.id, 'id': position.id}) }}')" class="fas fa-edit"></i></a>
                        <a href="#" title="{{ 'button.delete'|trans }}">
                            <i onclick="return removeMiscellaneousPositionFromInvoicePositions({{ position.id }})"
                                class="fas fa-trash-alt"></i></a>
                    </td>
                </tr>
            {% endfor %}
            <tr>
                <th><button type="button" class="btn btn-secondary invoice-edit-field d-none" onclick="return getContentForModal('{{ path('invoices.new.miscellaneous.position', {'invoiceId': invoice.id}) }}')">
                        <i class="fas fa-plus"></i> {{ 'invoice.position.add.miscellaneous'|trans }}</button></th>
                <th colspan="5" class="text-right">{{ positionSum|number_format(2, ',', '.') }}</th>
            </tr>
            </tbody>
        </table>

        <div class="row">
            <div class="col-md-4">
                {{ 'invoice.containing.vat'|trans }}<br/>
                <table>
                    {% for key, value in vats %}
                        <tr>
                            <td class="text-right">
                                {% if is_decimal_place_0(key) %}
                                    {{ key|number_format(0, ',', '.') }}
                                {% else %}
                                    {{ key|number_format(2, ',', '.') }}
                                {% endif %} %:
                            </td>
                            <td>&nbsp;&nbsp;</td>
                            <td class="text-right">{{ value.netto|number_format(2, ',', '.') }} €</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            <div class="col-md-6 text-right">{{ 'invoice.netto'|trans }}
                <br/><strong>{{ 'invoice.brutto'|trans }}</strong></div>
            <div class="col text-right">{{ (brutto-netto)|number_format(2, ',', '.') }} €<br/>
                <strong>{{ brutto|number_format(2, ',', '.') }} €</strong>
            </div>
        </div>
        <br/>
        <div class="row">
            <div class="col">
                <h4>{{ 'invoice.remark'|trans }}&nbsp;
                    <small>
                        <a href="#" onclick="return changeInvoiceRemark({{ invoice.id }});"
                           title="{{ 'button.edit'|trans }}" class="small invoice-edit-field d-none text-secondary">
                            <i class="fas fa-edit"></i>
                        </a>
                    </small>
                </h4>
                <div class="text-muted">{%if invoice.remark %}{{ invoice.remark|nl2br }}{% else %}-{% endif%}</div>
            </div>
        </div>

    </div>
</div>

<div class="modal-footer">
    <div class="col p-0" id="boxDefault">
        <form id="invoice-form-status"  role="form">   
           <div class="form-row"> 
                <div class="col-sm-2">
            <select id="invoce-status" name="invoice-status" class="form-control mr-sm-2">
                <option value="1"{% if invoice.status == 1 %} selected{% endif %}>{{ 'invoice.status.notpayed'|trans }}</option>
                <option value="2"{% if invoice.status == 2 %} selected{% endif %}>{{ 'invoice.status.payed'|trans }}</option>
            </select>
                </div>
            <div class="col-sm-3">
            <button id="save-status" type="button" class="btn btn-secondary d-none"
                    onclick="return updateInvoiceStatus({{ invoice.id }});">{{ 'button.save'|trans }}</button>
            </div>
            <div class="col text-right">
       
        <button type="button" class="btn btn-secondary " id="invoiceEditButton" 
                onclick="return toggleInvoiceEditFields();">{{ 'button.edit'|trans }}</button>
        <a href="{{ path('invoices.export.pdf', {'id': invoice.id, 'templateId': templateId }) }}" class="btn btn-secondary">{{ 'button.export.pdf'|trans }}</a>
        {% if is_granted('ROLE_ADMIN') %}
        <button type="button" class="btn btn-danger"
                    onclick="return toggleInvoiceDelete();">{{ 'button.delete'|trans }}</button>
        {% endif %}
            </div>
           </div>
        <input name="_csrf_token" value="{{ token }}" type="hidden">
        </form>
    </div>
    {% if is_granted('ROLE_ADMIN') %}
    <div id="boxDelete" class="d-none">
        <form id="invoiceDeleteForm" role="form">
            {{ 'invoice.delete.ask'|trans }}
            <button class="btn btn-danger" onclick="return doDeleteInvoice();">{{ 'button.delete'|trans }}</button>
            <button class="btn btn-secondary"
                    onclick="return toggleInvoiceDelete();">{{ 'button.cancel'|trans }}</button>
            <input type="hidden" name="id" value="{{ invoice.id }}"/>
            <input name="_csrf_token" value="{{ token }}" type="hidden">
        </form>
    </div>
    {% endif %}
</div>
<script type="text/javascript">
    $(document).ready(function () {
        fromOptions = {
            changeMonth: true,
            numberOfMonths: 2,
            regional: "{{ app.request.locale }}",
            onClose: function (selectedDate) {
                $("#end").datepicker("option", "minDate", selectedDate);

                if ($("#end").val().length === 0) {
                    var from = $(this).datepicker("getDate");
                    $("#end").datepicker("setDate", new Date(from.getFullYear(), from.getMonth(), (from.getDate() + 1)));
                    $("#from").datepicker("option", "maxDate", new Date(from.getFullYear(), from.getMonth(), (from.getDate() + 1)));
                }
            }
        };
        endOptions = {
            changeMonth: true,
            numberOfMonths: 2,
            regional: "{{ app.request.locale }}",
            onClose: function (selectedDate) {
                $("#from").datepicker("option", "maxDate", selectedDate);
            }
        }
        
        $("#invoce-status").change(function () {
            $("#save-status").fadeIn().removeClass("d-none");
        });
    });

    function updateInvoiceStatus(id) {
        var url = "{{ path('invoices.update.status', {'id': 'placeholder'}) }}";
        url = url.replace("placeholder", id);

        $.ajax({
            url: url,
            type: "post",
            data: $("#invoice-form-status").serialize(),
            beforeSend: function () {
                $("#save-status").prop("disabled", true);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
            },
            success: function (data) {
                $("#save-status").prop("disabled", false);
                $("#save-status").addClass("d-none");
            }
        });

        return false;
    }
    
    function toggleInvoiceEditFields() {
        var fields = $(".invoice-edit-field");
        if(fields.hasClass("d-none")) {
            fields.removeClass("d-none");
            $("#invoiceEditButton").addClass("d-none");
        } else {
            fields.addClass("d-none");
        }
    }
    
    function changeInvoiceCustomer(id) {
        var url = "{{ path('invoices.get.invoice.customer.change', {'id': 'placeholder'}) }}";
        url = url.replace("placeholder", id);
        var content = '<div class="modal-body">' +
                '     <img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" />' +
                '</div>';

        $.ajax({
            url: url,
            type: "get",
            beforeSend: function () {
                $("#modal-content-ajax").html(content);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
            },
            success: function (data) {
                $("#modal-content-ajax").html(data);
            }
        });

        return false;
    }
    
    function changeInvoiceNumber(id) {
        var url = "{{ path('invoices.edit.invoice.number.show', {'id': 'placeholder'}) }}";
        url = url.replace("placeholder", id);
        var content = '<div class="modal-body">' +
                '     <img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" />' +
                '</div>';

        $.ajax({
            url: url,
            type: "get",
            beforeSend: function () {
                $("#modal-content-ajax").html(content);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
            },
            success: function (data) {
                $("#modal-content-ajax").html(data);
            }
        });

        return false;
    }

    function removeAppartmentPositionFromInvoicePositions(id) {
        var url = "{{ path('invoices.delete.appartment.invoice.position') }}";
        var content = '<div class="modal-body">' +
                '     <img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" />' +
                '</div>';

        $.ajax({
            url: url,
            type: "post",
            data: {appartmentInvoicePositionEditId: id},
            beforeSend: function () {
                $("#modal-content-ajax").html(content);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
            },
            success: function (data) {
                $("#modal-content-ajax").html(data);
            }
        });

        return false;
    }

    function removeMiscellaneousPositionFromInvoicePositions(id) {
        var url = "{{ path('invoices.delete.miscellaneous.invoice.position') }}";
        var content = '<div class="modal-body">' +
                '     <img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" />' +
                '</div>';

        $.ajax({
            url: url,
            type: "post",
            data: {miscellaneousInvoicePositionEditId: id},
            beforeSend: function () {
                $("#modal-content-ajax").html(content);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
            },
            success: function (data) {
                $("#modal-content-ajax").html(data);
            }
        });

        return false;
    }
    
    function changeInvoiceRemark(id) {
        var url = "{{ path('invoices.edit.invoice.remark.show', {'id': 'placeholder'}) }}";
        url = url.replace("placeholder", id);
        var content = '<div class="modal-body">' +
                '     <img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" />' +
                '</div>';

        $.ajax({
            url: url,
            type: "get",
            beforeSend: function () {
                $("#modal-content-ajax").html(content);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
            },
            success: function (data) {
                $("#modal-content-ajax").html(data);
            }
        });

        return false;
    }
    
    function toggleInvoiceDelete() {
        if ($("#boxDelete").is(":hidden")) {
            $("#boxDelete").fadeIn().removeClass('d-none');
            $("#boxDefault").addClass("d-none");
        }
        else {
            $("#boxDelete").addClass("d-none");
            $("#boxDefault").fadeIn().removeClass('d-none');;
        }
        return false;
    }
</script>
