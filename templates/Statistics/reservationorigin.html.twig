{% extends 'base.html.twig' %}

{% block title %}
    {{ parent() }} -  {{ 'statistics.origin.title'|trans }}
{% endblock %}

{% block description %}
    {{ parent() }} -  {{ 'statistics.origin.title'|trans }}
{% endblock %}

{# create list of localized month #}
{% set monthList = [] %}
{% for i in 1..12 %}
    {% set monthList = monthList|merge([getLocalizedMonth(i, 'MMMM', app.request.locale)]) %}
{% endfor %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <form id="table-filter" class="form-inline" role="form">                   
                    <div class="form-group pull-right">
                        <select id="objects" name="object" class="form-control">
                            <option value="all">{{ 'reservation.objects.all'|trans }}</option>
                            {% for object in objects %}
                                <option value="{{ object.id }}"{% if object.id == objectId %} selected{% endif %}>{{ object.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <div class="row">
                    <div class="col-md-5">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                {{ 'statistics.origin.monthly'|trans }}
                                 <span id="refreshMonthly" class="glyphicon glyphicon-refresh pull-right" aria-hidden="true" style="cursor: pointer;"></span>
                            </div>
                            <div class="panel-body">
                                <div id="monthlyChart" style="height: 300px"><img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" /></div>
                            </div>
                            <div class="panel-footer">
                                <form class="form-inline" role="form">
                                    <div class="form-group">
                                    </div>
                                    <div class="form-group">
                                        <select id="monthlyStart" name="monthtlyStart" class="form-control">
                                            {% set currentMonth = 'now'|date('n') %}
                                            {% for month in monthList %}
                                                <option value="{{ loop.index }}"{%if loop.index == currentMonth %} selected="selected"{% endif %}>{{ month }}</option>
                                            {% endfor %}
                                        </select>
                                        <select id="monthlyStartYear" name="monthtlyStartYear" class="form-control">
                                            {% set currentYear = 'now'|date('Y') %}
                                            {% for i in minYear..maxYear %}
                                                <option value="{{ i }}"{%if i == currentYear %} selected="selected"{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                        &nbsp;-&nbsp; 
                                        <select id="monthlyEnd" name="monthtlyEnd" class="form-control">
                                            {% for month in monthList %}
                                                <option value="{{ loop.index }}"{%if loop.index == currentMonth %} selected="selected"{% endif %}>{{ month }}</option>
                                            {% endfor %}
                                        </select>
                                        <select id="monthlyEndYear" name="monthtlyEndYear" class="form-control">
                                            {% for i in minYear..maxYear %}
                                                <option value="{{ i }}"{%if i == currentYear %} selected="selected"{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5 col-md-offset-1">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                {{ 'statistics.origin.yearly'|trans }}
                                 <span id="refreshYearly" class="glyphicon glyphicon-refresh pull-right" aria-hidden="true" style="cursor: pointer;"></span>
                            </div>
                            <div class="panel-body">
                                <div id="yearlyChart" style="height: 300px"><img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" /></div>
                            </div>
                            <div class="panel-footer">
                                <form class="form-inline" role="form">
                                    <div class="form-group">
                                    </div>
                                    <div class="form-group">
                                        <select id="yearlyStartYear" name="yearlyStartYear" class="form-control">
                                            {% for i in minYear..maxYear %}
                                                <option value="{{ i }}"{%if i == currentYear %} selected="selected"{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                        &nbsp;-&nbsp; 
                                        <select id="yearlyEndYear" name="yearlyEndYear" class="form-control">
                                            {% for i in minYear..maxYear %}
                                                <option value="{{ i }}"{%if i == currentYear %} selected="selected"{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id='tooltip'></div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ app.request.basepath }}/resources/js/jquery.flot.min.js"></script>
    <script type="text/javascript" src="{{ app.request.basepath }}/resources/js/jquery.flot.pie.min.js"></script>
    <script type="text/javascript" src="{{ app.request.basepath }}/resources/js/jquery.flot.resize.js"></script>
    <script>

    $(document).ready(function () {
        
        $("#objects").change(function () {
            drawMonthlyChart();
            drawYearlyChart();
        });
        
        $("#monthlyStart, #monthlyEnd, #monthlyStartYear, #monthlyEndYear").change(function () {
            drawMonthlyChart();
        });
        
        $("#refreshMonthly").click(function () {
            drawMonthlyChart();
        });
        
        $("#yearlyStartYear, #yearlyEndYear").change(function () {
            drawYearlyChart();
        });
        
        $("#refreshYearly").click(function () {
            drawYearlyChart();
        });
        
        drawMonthlyChart();
        drawYearlyChart();
    });
        
    function drawMonthlyChart() {
        var objId = $("#objects").val();
        var start = $("#monthlyStart").val();
        var end = $("#monthlyEnd").val();
        var startYear = $("#monthlyStartYear").val();
        var endYear = $("#monthlyEndYear").val();
        $("#monthlyChart").html('<img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" />');
        $.ajax({
            url: '{{ path('statistics.origin.monthtly') }}',
            data: {monthStart: start, monthEnd: end, yearStart: startYear, yearEnd: endYear, objectId: objId}
        }).done(function (values) {
            
            
            $.plot($("#monthlyChart"), values, {
                series: {
                    pie: {
                        show: true,
                        label: {
                            show: true,
                            radius: 1,
                            formatter: labelFormatter,
                            background: {
                                opacity: 0.8
                            }
                        }
                    }
                }
            }); 
        });
    }
    
    function drawYearlyChart() {
        var objId = $("#objects").val();
        var startYear = $("#yearlyStartYear").val();
        var endYear = $("#yearlyEndYear").val();
        $("#yearlyChart").html('<img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif" />');
        $.ajax({
            url: '{{ path('statistics.origin.yearly') }}',
            data: {yearStart: startYear, yearEnd: endYear, objectId: objId}
        }).done(function (values) {

            $.plot($("#yearlyChart"), values, {
                series: {
                    pie: {
                        show: true,
                        label: {
                            show: true,
                            radius: 1,
                            formatter: labelFormatter,
                            background: {
                                opacity: 0.8
                            }
                        }
                    }
                }
            }); 
        });
    }
    
    function labelFormatter(label, series) {
        return "<div style='font-size:8pt; text-align:center; padding:2px; color:white;'>" + Math.round(series.percent) + "%</div>";
    }
    </script>
{% endblock %}
