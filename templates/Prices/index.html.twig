{% extends 'base.html.twig' %}

{% block title %}
    {{ parent() }} -  {{ 'object.title'|trans }}
{% endblock %}

{% block description %}
    {{ parent() }} -  {{ 'object.description'|trans }}
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col">
            <button type="button" class="btn btn-secondary" onclick="showCreatePriceForm()" data-toggle="modal"
                    data-target="#modalCenter">
                <i class="fas fa-plus"></i> {{ 'nav.price.add'|trans }}</button>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <table class="table table-bordered table-hover">
                <thead>
                <tr>
                    <th>{{ 'price.description'|trans }}</th>
                    <th>{{ 'price.seasonstart'|trans }}</th>
                    <th>{{ 'price.seasonend'|trans }}</th>
                    <th>{{ 'price.daysinweek'|trans }}</th>
                    <th>{{ 'price.price'|trans }}</th>
                    <th>{{ 'price.vat'|trans }}</th>
                    <th>{{ 'price.type'|trans }}</th>
                    <th>{{ 'price.active'|trans }}</th>
                    <th>{{ 'base.action'|trans }}</th>
                </tr>
                </thead>
                <tbody>
                {% for price in prices %}
                    <tr>
                        <td>{{ price.description }}</td>
                        <td>{% if price.seasonstart %}{{ price.seasonstart|date('d.m.Y') }}{% endif %}</td>
                        <td>{% if price.seasonend %}{{ price.seasonend|date('d.m.Y') }}{% endif %}</td>
                        <td>
                            {% if price.alldays == true %}{{ 'price.abbreviation.alldays'|trans }}{% endif %}
                            {% if price.monday == true %}{{ 'price.abbreviation.monday'|trans }}{% endif %}
                            {% if price.tuesday == true %}{{ 'price.abbreviation.tuesday'|trans }}{% endif %}
                            {% if price.wednesday == true %}{{ 'price.abbreviation.wednesday'|trans }}{% endif %}
                            {% if price.thursday == true %}{{ 'price.abbreviation.thursday'|trans }}{% endif %}
                            {% if price.friday == true %}{{ 'price.abbreviation.friday'|trans }}{% endif %}
                            {% if price.saturday == true %}{{ 'price.abbreviation.saturday'|trans }}{% endif %}
                            {% if price.sunday == true %}{{ 'price.abbreviation.sunday'|trans }}{% endif %}
                        </td>
                        <td class="text-right">{{ price.price|number_format(2, ',', '.') }}</td>
                        <td class="text-right">
                            {% if is_decimal_place_0(price.vat) %}
                                {{ price.vat|number_format(0, ',', '.') }}
                            {% else %}
                                {{ price.vat|number_format(2, ',', '.') }}
                            {% endif %}
                        </td>
                        <td>{% if price.type == 1 %}
                                {{ 'price.miscellaneous'|trans }}
                            {% elseif price.type == 2 %}
                                {{ 'price.appartment'|trans }}
                            {% endif %}
                        </td>
                        <td>{% if price.active == true %}{{ 'price.active'|trans }} {% else %} {{ 'price.inactive'|trans }}{% endif %}</td>
                        <td>
                            <a href="#" title="{{ 'button.details'|trans }}" data-toggle="modal" data-target="#modalCenter">
                                <i onclick="getEntity({{ price.id }})" class="fas fa-info-circle"></i></a>
                            <a href="#" title="{{ 'button.edit'|trans }}">
                                <i onclick="editEntry({{ price.id }})" class="fas fa-edit" data-toggle="modal" data-target="#modalCenter"></i></a>
                            <a href="#" title="{{ 'button.delete'|trans }}">
                                <i onclick="deleteEntry({{ price.id }})" class="fas fa-trash-alt"></i></a>
                        </td>
                    </tr>
                    <tr id="entry-{{ price.id }}" class="d-none">
                        <td colspan="9" id="entry-cell-{{ price.id }}">
                            <img src="{{ app.request.basepath }}/resources/images/ajax-loader.gif"/>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ app.request.basepath }}/resources/js/settings.js"></script>
    <script>

    $.ajaxSetup({
        cache: false
    });
    </script>
{% endblock %}
{% block bodyjs %}
    {{ parent() }}
    <script>

    $.ajaxSetup({
        cache: false
    });


    function enablePriceForm(id) {
        var formFieldsetPrimary = "#price-form-fieldset-primary-" + id;
        var formFieldsetSecondary = "#price-form-fieldset-secondary-" + id;
        var cancelButton = "#price-cancel-" + id;
        var editButton = "#price-edit-" + id;
        var saveButton = "#price-submit-" + id;
        $(cancelButton).html('Abbrechen');
        $(editButton).addClass('button-hidden');
        $(saveButton).removeClass('button-hidden');
        $(formFieldsetPrimary).removeAttr('disabled');
        $(formFieldsetSecondary).removeAttr('disabled');

        return false;
    }
    ;
    
    function showCreatePriceForm() {
        getContentForModal("{{ path('prices.new.price') }}");
    }
    
    function getEntity(id) {
        let url = replacePlaceholder("{{ path('prices.get.price', {'id': 'placeholder'}) }}", id);
        getContentForModal(url);        
    }
    
    function editEntry(id) {
        let url = replacePlaceholder("{{ path('prices.get.price', {'id': 'placeholder'}) }}", id);
        getContentForModal(url, "", function() {
            enableEditForm(id);
        });        
    }

    function savePrice(id) {
        let url = replacePlaceholder("{{ path('prices.edit.price', {'id': 'placeholder'}) }}", id);
        return _doPost('#entry-form-'+id, url);
    }

    function deleteEntry(id) {
        let url = replacePlaceholder("{{ path('prices.delete.price', {'id': 'placeholder'}) }}", id);
        _deleteEntry(id, url);        
    }

    function doDeleteEntry(id) {
        let url = replacePlaceholder("{{ path('prices.dodelete.price', {'id': 'placeholder'}) }}", id);
        return _doPost('#entry-form-'+id, url);
    }

    function createNewPrice() {
        var url = "{{ path('prices.create.price')}}";

        $.ajax({
            url: url,
            type: "post",
            data: $("#entry-form-new").serialize(),
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
            },
            success: function (data) {
                if (data.length > 0) {
                    $("#flash-message-overlay").empty();
                    $("#flash-message-overlay").append(data);
                } else {
                    window.location.href = "{{ path('prices.overview') }}";
                }
            }
        });

        return false;
    }
    ;

    function checkIfTypeIsAppartment(id) {
        if ($('#type-' + id).val() === 2) {
            $('#price-form-fieldset-type-appartment-' + id).removeAttr('disabled');
            $('#collapseThree-' + id).removeClass('collapse');
            $('#price-form-fieldset-type-appartment-' + id + ' #number-of-persons').attr('required', true);
            $('#price-form-fieldset-type-appartment-' + id + ' #number-of-beds').attr('required', true);
            $('#price-form-fieldset-type-appartment-' + id + ' #min-stay').attr('required', true);
        } else {
            $('#price-form-fieldset-type-appartment-' + id).attr('disabled', true);
            $('#collapseThree-' + id).addClass('collapse');
            $('#price-form-fieldset-type-appartment-' + id + ' #number-of-persons').removeAttr('required');
            $('#price-form-fieldset-type-appartment-' + id + ' #number-of-beds').removeAttr('required');
            $('#price-form-fieldset-type-appartment-' + id + ' #min-stay').removeAttr('required');
        }

        return false;
    }

    function checkAllCheckboxes(id) {
        
        if ($('#collapseTwo-' + id + ' #alldays-' + id).is(':checked')) {
            $('#collapseTwo-' + id + ' :checkbox').prop('checked', true);
        } else {
            $('#collapseTwo-' + id + ' :checkbox').prop('checked', false);
        }

        return false;
    }
    </script>
{% endblock %}
